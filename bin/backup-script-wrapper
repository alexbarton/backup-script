#!/bin/sh
#
# backup-script system for cloning systems using rsync
# Copyright (c)2008-2015 Alexander Barton, alex@barton.de
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# Please read the file COPYING, README and AUTHORS for more information.
#

if [ -z "$MAILTO" ]; then
	if id "logcheck" >/dev/null 2>&1; then
		MAILTO="logcheck"
	elif fgrep "logcheck:" /etc/aliases >/dev/null 2>&1; then
		MAILTO="logcheck"
	else
		MAILTO="root"
	fi
fi

NAME="backup-script"
HOST=`hostname`
TMP=`mktemp /tmp/$NAME.XXXXXXXX` || exit 11
LOGFILE="/var/log/backup-script.log"

PATH="$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
export PATH

exec >"$TMP" 2>&1

echo "$NAME Report"
echo
echo " - Host: `hostname -f`"
echo " - User: `id -un`"
echo

if [ -w "$LOGFILE" ]; then
	"$(dirname "$0")/backup-script" "$@" | tee -a "$LOGFILE"
else
	"$(dirname "$0")/backup-script" "$@"
	echo "(Can't write logfile: \"$LOGFILE\"!)"
fi

cat "$TMP" | mail -s "$HOST: $NAME results" "$MAILTO"

rm -f "$TMP"

# -eof-
